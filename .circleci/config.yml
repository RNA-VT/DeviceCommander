version: 2.1
parameters:
  device-commander-version:
    type: string
    default: "0.0.1"
orbs:
  docker: circleci/docker@1.7.0
executors:
  docker-publisher:
    docker:
      - image: circleci/buildpack-deps:latest-alpine
jobs:
  test:
    docker:
      - image: circleci/golang:1.17
    steps:
      - checkout
      - run:
          working_directory: ./src
          name: Run tests
          command: |
            go test -v ./test
  lint:
    docker:
      - image: golangci/golangci-lint:v1.37-alpine
    steps:
      - checkout
      - run:
          working_directory: ./src
          command: |
            apk add libpcap-dev
            golangci-lint run
workflows:
  version: 2
  devicecommander-build:
    jobs:
      - lint
      - docker/publish:
          name: build-and-publish
          image: rnavt/devicecommander
          context: docker_hub
          docker-context: .
          tag: ${CIRCLE_SHA1:0:7},$CIRCLE_BRANCH
          filters:
              branches:
                only:
                  - master
